apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: edgecomllc-eupf-nat-n6
  namespace: open5gs
spec:
  config: |
    {
      "cniVersion": "0.3.1",
      "name": "edgecomllc-eupf-nat-n6",
      "type": "bridge",
      "bridge": "eupf-n6",
      "ipMasq": false,
      "isGateway": false,
      "isDefaultGateway": false,
      "ipam": {
        "type": "static"
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/instance: edgecomllc-eupf
    app.kubernetes.io/name: nat
  name: edgecomllc-eupf-nat
  namespace: open5gs
data:
  run.sh: |
    #!/bin/bash

    set -x

    ip ro add 10.45.0.0/16 via 10.99.0.10
    iptables -t nat -A POSTROUTING -s 10.45.0.0/16 -o eth0 -j MASQUERADE

    set +x

    # apk add ethtool
    # ethtool -K eth0 tx off
    # ethtool -K n6 tx off

    while true; do echo "i am alive"; sleep 30; done;
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/instance: edgecomllc-eupf
    app.kubernetes.io/name: nat
  name: edgecomllc-eupf-nat
  namespace: open5gs
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: edgecomllc-eupf
      app.kubernetes.io/name: nat
  template:
    metadata:
      annotations:
        k8s.v1.cni.cncf.io/networks: |
          [
            {
              "name": "edgecomllc-eupf-nat-n6",
              "interface": "n6",
              "ips": [ "10.99.0.254/24" ]
            }
          ]
      labels:
        app.kubernetes.io/instance: edgecomllc-eupf
        app.kubernetes.io/name: nat
        version: latest
    spec:
      containers:
      - name: nat
        image: praqma/network-multitool:c3d4e04
        imagePullPolicy: Always
        command: [ "/conf/run.sh" ]
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 100m
            memory: 128Mi
        securityContext:
          privileged: true
        volumeMounts:
          - mountPath: /conf
            name: config
      securityContext:
        sysctls:
        - name: net.ipv4.ip_forward
          value: "1"
      volumes:
      - configMap:
          defaultMode: 420
          items:
            - key: run.sh
              mode: 493
              path: run.sh
          name: edgecomllc-eupf-nat
        name: config
