---

args:
  - --config
  - /app/conf/config.yml

securityContext:
  privileged: true

podSecurityContext:
  sysctls:
  - name: net.ipv4.ip_forward
    value: "1"

deploymentStrategy:
  type: Recreate

configMaps:
  config:
    data:
      config.yml: |
        interface_name: eth0
        api_address: :8080
        pfcp_address: :8805
        metrics_address: :9090
  bird:
    data:
      bird.conf: |
        router id 10.233.64.1;

        protocol bfd {
        }

        protocol direct {
          interface "*";
        }

        protocol kernel {
          learn;
          scan time 5;
          import all;
          export all;
        }

        protocol device {
          scan time 5;
        }

        protocol static eupf {
          route 10.45.0.0/16 reject;
        }

        protocol bgp node_local {
          keepalive time 20;
          hold time 60;
          graceful restart aware;
          local as 65000;
          neighbor 188.120.253.172 as 64512;

          debug all;
          multihop;
          gateway recursive;
          connect delay time 2;
          connect retry time 5;
          error wait time 5,30;

          import all;
          export where proto = "eupf";
        }

env:
  UPF_PFCP_NODE_ID: $(MY_POD_IP)
  UPF_N3_ADDRESS: $(MY_POD_IP)

volumes:
  - name: sys
    hostPath:
      path: /sys
  - name: config
    configMap:
      name: eupf-config
      defaultMode: 420
      items:
        - key: config.yml
          mode: 493
          path: config.yml
  - name: bird
    configMap:
      name: eupf-bird
      defaultMode: 420

volumeMounts:
  - name: sys
    mountPath: /sys
    readOnly:  true
  - name: config
    mountPath: /app/conf
  - name: bird
    mountPath: /opt/bird/conf

metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    additionalLabels:
      release: kube-prometheus-stack
    endpoints:
      port: metrics
      path: "/metrics"

extraContainerPorts:
  - name: gtpu
    containerPort: 2152
    protocol: UDP
  - name: pfcp
    containerPort: 8805
    protocol: UDP

service:
  type: ClusterIP
  port: 8080
  extraPorts:
    - port: 2152
      targetPort: gtpu
      protocol: UDP
      name: gtpu
    - port: 8805
      targetPort: pfcp
      protocol: UDP
      name: pfcp

resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:
    cpu: 100m
    memory: 128Mi

livenessProbe:
  tcpSocket:
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10

readinessProbe:
  tcpSocket:
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10

podAnnotations:
  cni.projectcalico.org/ipv4pools: '["default-pool"]'
  cni.projectcalico.org/ipAddrs: '["10.233.64.1"]'

bird:
  enabled: true
