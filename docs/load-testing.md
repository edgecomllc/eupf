# Perfomance testing

eUPF is tested in several ways:

1. Baremetal deployment without the rest core NFs to measure overall performance results
2. In conjunction with Open5GS and Free5GC cores to compare to default UPFs

## General performance tests

### Testbed description

* 2 baremetal nodes connected directly: generator (T-Rex) & DUT
* CPU on both sides: Intel(R) Xeon(R) Gold 6342 CPU @ 2.80GHz
* Network card on both sides: Mellanox Technologies MT27800 Family [ConnectX-5]

### eUPF configuration

eUPF is deployed using docker-compose on baremetal server in `host` network mode and `native` ebpf attachment mode.

<details><summary>docker-compose.yaml</summary>

```bash
version: '3.3'

services:
  eupf:
    container_name: eupf
    image: ghcr.io/edgecomllc/eupf:0.5.2
    privileged: true
    network_mode: "host"
    command: --iface ens64f0np0 --n3addr 10.100.200.14 --nodeid 10.100.200.14 --paddr :8805 --attach native --loglvl debug
    volumes:
      - /sys/fs/bpf:/sys/fs/bpf
    environment:
      GIN_MODE: release
    ulimits:
      memlock: -1
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_RESOURCE # setrlimit
```
</details>

### T-Rex configuration

<details><summary>Common trex setting /etc/trex_cfg.yaml</summary>

```bash
### Config file generated by dpdk_setup_ports.py ###

- version: 2
  interfaces: ['03:00.0', '03:00.1']
  limit_memory: 10240
  port_info:
      - ip: 10.209.0.1
        default_gw: 10.209.1.1
        dest_mac: 10:70:fd:2f:b7:30 # MAC OF LOOPBACK TO IT'S DUAL INTERFACE
        src_mac:  10:70:fd:2f:ab:dc
      - ip: 10.209.0.2
        default_gw: 10.209.1.2
        dest_mac: 10:70:fd:2f:b7:31 # MAC OF LOOPBACK TO IT'S DUAL INTERFACE
        src_mac:  10:70:fd:2f:ab:dd

  platform:
      master_thread_id: 0
      latency_thread_id: 49
      dual_if:
        - socket: 0
          threads: [1,2,3,4,5,6,7,8]
```
</details>

<details><summary>Trex load profile</summary>

```python
from trex_stl_lib.api import *
from scapy.contrib.gtp import GTP_U_Header as GTP_U_Header
import argparse

class STLS1(object):

    def create_stream (self):
        return STLStream(
            packet =
                    STLPktBuilder(
                        pkt = Ether()/IP(src="16.0.0.1",dst="48.0.0.1")/
                                UDP(dport=2152,sport=2152)/
                                GTP_U_Header()/
                                IP(src="10.60.0.1", dst="1.2.3.4")/
                                UDP()/
                                (300*'x')
                    ),
             mode = STLTXCont())

    def get_streams (self, tunables, **kwargs):
        parser = argparse.ArgumentParser(description='Argparser for {}'.format(os.path.basename(__file__)),
                                         formatter_class=argparse.ArgumentDefaultsHelpFormatter)
        args = parser.parse_args(tunables)
        # create 1 stream
        return [ self.create_stream() ]

def register():
    return STLS1()
```
</details>


<details><summary>Run commands</summary>

```bash
sudo ./t-rex-64 -i
```

```
./trex-console
trex>start -f stl/gtp_1pkt_simple.py -p 0 -m 5mpps -d 300
```
</details>

### Test case 1 (1 PDU-session + 1 flow)

* eUPF runs on DUT in standalone mode
* eUPF configured with 1 PDU session via API
* T-Rex sends N3 packets (Ethernet/IP/UDP/GTP/IP/UDP/Payload) according to configured speed
* eUPF proccesses N3 packets according to installed PDRs and sends N6 packets back
* T-Rex receives N3 packets and count how many packets are lost 

<details><summary>eUPF configuration via API</summary>

1. Set FAR with ID = 0 and action = `forward`
```bash
curl -H 'Content-Type: application/json' -X PUT -d '{"action":2, "outer_header_creation":0,"teid":0,"remote_ip":0, "local_ip": 0,"transport_level_marking": 0}' http://localhost:8080/api/v1/far_map/0
```

2. Set QER with ID = 0 and no bitrate limitations
```bash
curl -H 'Content-Type: application/json' -X PUT -d '{"gate_status_ul":0,"gate_status_dl":0,"qfi":0,"max_bitrate_ul":0,"max_bitrate_dl":0}' http://localhost:8080/api/v1/qer_map/0
```

3. And, finally, set PDR for TEID = 0 and with FARID = 0, QERID = 0
```bash
curl -H 'Content-Type: application/json' -X PUT -d '{"outer_header_removal":0,"far_id":0,"qer_id":0}' http://localhost:8080/api/v1/uplink_pdr_map/0
```

</details>

### Results

#### 10 byte payload

| Rx queue size | Throughput | Throughput pps | CPU load* | Packet loss |
| ------------- | ---------- | -------------- | --------- | ----------- |
| 1             | 1Mpps      | 700Mbps        | 0%        | 0%          |
| 1             | 2Mpps      | 1,5Gbps        | 0%        | 0,03%       |
| 1             | 3Mpps      | 2.2Gbps        | 0%        | 0,05%       |
| 1             | 5Mpps      | 3,6Gbps        | ~20%      | 1,58%       |
| 1             | 7Mpps      | 5,1Gbps        | ~100%     | 14,6%       |

*CPU load - per core. In this case only one core is used (one rx queue)

#### 300 byte payload

| Rx queue size | Throughput | Throughput pps | CPU load* | Packet loss |
| ------------- | ---------- | -------------- | --------- | ----------- |
| 1             | 1Mpps      | 3Gbps          | 0%        | 0%          |
| 1             | 2Mpps      | 6,1Gbps        | 0%        | 0,09%       |
| 1             | 3Mpps      | 9Gbps          | 0%        | 0,11%       |
| 1             | 5Mpps      | 15Gbps         | ~20%      | 1,71%       |
| -             | 7Mpps      | -              | -         | -           |

*CPU load - per core. In this case only one core is used (one rx queue)

### Test case 2 (N PDU-session + 1 flow)

TBD

### Test case 3 (N PDU-session + Y flow)

TBD

## Comparative testing

Let's compare eUPF with Opne5GS UPF and Free5GC UPF.

Consider following test scenarios:

* tcp throughput to neighbor pod (using `iperf` utility)
* latency to neighbor pod (using `mtr` utility)
* latency to google public DNS (using `mtr` utility)

### Limitation
* eUPF runs in `generic` xdp attachment mode. This is the most slowest mode used preliminary for debugging. No performance benefits in this mode, actually. Using `native` mode is supposed to get real performance advantage.
* eUPF doesn't support NAT. So additional NAT container is used to proper connection to external resources. Additional network hop adds more latency in test and decreases performance

### Open5gs
<details><summary>How to prepare and test</summary>
<p>

#### iperf

* install iperf server

```bash
helm upgrade --install \
  iperf3 openverso/iperf3 \
  --values docs/examples/open5gs/iperf.yaml \
  --version 0.1.2 \
  --namespace open5gs \
  --wait --timeout 30s --create-namespace
```

* run shell in ueransim ue pod

```
kubectl -n open5gs exec -ti deployment/ueransim-ueransim-gnb-ues -- /bin/bash
```

* install iperf3

```bash
apk add iperf3
```

* check tcp throughput (without upf)

```bash
$ iperf3 -c iperf3 -p 5201 -t 30 -R
Connecting to host iperf3, port 5201
Reverse mode, remote host iperf3 is sending
...
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-30.00  sec  45.8 GBytes  13.1 Gbits/sec  4369             sender
[  5]   0.00-30.00  sec  45.8 GBytes  13.1 Gbits/sec                  receiver

iperf Done.
```

* check tcp throughput (with open5gs upf)

```bash
$ export UESIMTUNO_IP=$(ip -o -4 addr list uesimtun0 | awk '{print $4}' | cut -d/ -f1)
$ iperf3 -c iperf3 -p 5201 -t 30 -R -B ${UESIMTUNO_IP}
Connecting to host iperf3, port 5201
Reverse mode, remote host iperf3 is sending
...
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-30.00  sec   612 MBytes   171 Mbits/sec  554             sender
[  5]   0.00-30.00  sec   612 MBytes   171 Mbits/sec                  receiver

iperf Done.
```

* check tcp throughput (with eUPF)

we should use some flags for iperf client (specific for eUPF):
- packet size (`-M`)
- pod address (`-c`)

```bash
$ iperf3 -c 10.233.110.181 -p 5201 -t 30 -R --bind-dev uesimtun0 -M 1350
Connecting to host 10.233.110.181, port 5201
Reverse mode, remote host 10.233.110.181 is sending
...
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-30.00  sec   490 MBytes   137 Mbits/sec  1181             sender
[  5]   0.00-30.00  sec   490 MBytes   137 Mbits/sec                  receiver
```

#### mtr

* run shell in ueransim ue pod

```
kubectl -n open5gs exec -ti deployment/ueransim-ueransim-gnb-ues -- /bin/bash
```

* install mtr

```bash
apk add mtr
```

* check latency (without upf) to iperf3 pod

```bash
$ mtr --no-dns --report --report-cycles 60 -T -P 5201 iperf3
...
HOST: ueransim-ueransim-gnb-ues-5 Loss%   Snt   Last   Avg  Best  Wrst StDev
  1.|-- 10.233.10.221              0.0%    60    0.2   0.2   0.1   0.3   0.0
```

* check latency (without upf) to google public dns

```bash
$ mtr --no-dns --report --report-cycles 60 -T -P 443 8.8.8.8
...
HOST: ueransim-ueransim-gnb-ues-5 Loss%   Snt   Last   Avg  Best  Wrst StDev
...
 16.|-- 8.8.8.8                   96.7%    60   16.8  15.7  14.7  16.8   1.5
```

* check latency (with open5gs upf) to iperf3 pod

```bash
$ mtr --no-dns --report --report-cycles 60 -T -P 5201 -I uesimtun0 iperf3
...
HOST: ueransim-ueransim-gnb-ues-5 Loss%   Snt   Last   Avg  Best  Wrst StDev
  1.|-- 10.45.0.1                  0.0%    60    1.0   1.0   0.7   1.7   0.2
  2.|-- 10.233.10.221              0.0%    60    1.0   1.2   0.8   2.5   0.3
```

* check latency (with open5gs upf) to google public dns

```bash
$ mtr --no-dns --report --report-cycles 60 -T -P 443 -I uesimtun0 8.8.8.8
...
HOST: ueransim-ueransim-gnb-ues-5 Loss%   Snt   Last   Avg  Best  Wrst StDev
 1.|-- 10.45.0.1                  0.0%    60    1.3   1.1   0.7   2.4   0.3
...
 17.|-- 8.8.8.8                   96.7%    60   17.2  19.2  17.2  21.2   2.9
```

* check latency (with eUPF) to iperf3 pod

```bash
$ mtr --no-dns --report --report-cycles 60 -T -P 5201 -I uesimtun0 10.233.110.181
HOST: ueransim-ueransim-gnb-ues-5 Loss%   Snt   Last   Avg  Best  Wrst StDev
  3.|-- 10.233.110.181             0.0%    60    0.9   1.0   0.6   1.3   0.1
```

* check latency (with eUPF) to google public dns

```bash
$ mtr --no-dns --report --report-cycles 60 -T -P 443 -I uesimtun0 8.8.8.8
...
HOST: ueransim-ueransim-gnb-ues-5 Loss%   Snt   Last   Avg  Best  Wrst StDev
  1.|-- 10.99.0.254                0.0%    60    1.1   1.0   0.8   1.5   0.1
...
 17.|-- 8.8.8.8                   95.0%    60   14.6  16.9  14.6  21.3   3.8
```

</p>
</details>

### Results

|scenario | raw | open5gs upf | eupf |
|---|---|---|---|
| tcp throughput (to neighbor pod) | 13.1 Gbit/sec | 171 Mbit/sec | 137 Mbit/sec |
| latency (to neighbor pod) | 0.2 | 1.2 | 1.0 |
| latency (to google public DNS) | 15.7 | 19.2 | 16.9 |


### Free5GC
<details><summary>How to prepare and test</summary>
<p>


#### iperf

* install iperf server

```bash
helm upgrade --install \
  iperf3 openverso/iperf3 \
  --values docs/examples/free5gc/iperf.yaml \
  --version 0.1.2 \
  --namespace free5gc \
  --wait --timeout 30s --create-namespace
```

* run shell in ueransim ue pod

```
kubectl -n free5gc exec -ti deployment/ueransim-ue -- /bin/bash
```

* install iperf3

```bash
apt-get update && apt-get install -y iperf3
```

* check tcp throughput (without upf)

```bash
$ iperf3 -c iperf3 -p 5201 -t 30 -R
...
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-30.00  sec  45.8 GBytes  13.1 Gbits/sec  4369             sender
[  5]   0.00-30.00  sec  45.8 GBytes  13.1 Gbits/sec                  receiver
```

* check tcp throughput (with free5gc upf)

```bash
$ export UESIMTUNO_IP=$(ip -o -4 addr list uesimtun0 | awk '{print $4}' | cut -d/ -f1)
$ iperf3 -c iperf3 -p 5201 -t 30 -R --bind ${UESIMTUNO_IP}
...
 ID] Interval           Transfer     Bandwidth       Retr
[  4]   0.00-30.00  sec  1022 MBytes   286 Mbits/sec  715             sender
[  4]   0.00-30.00  sec  1022 MBytes   286 Mbits/sec                  receiver
```

* check tcp throughput (with eUPF)

we should use some flags for iperf client (specific for eUPF):
- packet size (`-M`)
- pod address (`-c`)

```bash
$ export UESIMTUNO_IP=$(ip -o -4 addr list uesimtun0 | awk '{print $4}' | cut -d/ -f1)
$ iperf3 -c 10.233.110.144 -p 5201 -t 30 -R --bind ${UESIMTUNO_IP}
...
[ ID] Interval           Transfer     Bandwidth       Retr
[  4]   0.00-30.00  sec   673 MBytes   188 Mbits/sec  2338             sender
[  4]   0.00-30.00  sec   673 MBytes   188 Mbits/sec                  receiver
```

#### mtr

* run shell in ueransim ue pod

```
kubectl -n free5gc exec -ti deployment/ueransim-ue -- /bin/bash
```

* install mtr

```bash
apt-get update && apt-get install -y mtr
```

* check latency (without upf) to iperf3 pod

```bash
$ mtr --no-dns --report --report-cycles 60 -T -P 5201 iperf3
...
HOST: ueransim-ue-7f76db59c9-ltfl Loss%   Snt   Last   Avg  Best  Wrst StDev
  1.|-- 10.233.27.59               0.0%    60    0.3   0.2   0.2   0.4   0.0
```

* check latency (without upf) to google public dns

```bash
$ mtr --no-dns --report --report-cycles 60 -T -P 443 8.8.8.8
...
HOST: ueransim-ue-7f76db59c9-ltfl Loss%   Snt   Last   Avg  Best  Wrst StDev
...
 16.|-- 8.8.8.8                   96.7%    60   16.6  16.4  16.2  16.6   0.3
```

* check latency (with free5gc upf) to iperf3 pod

```bash
$ export UESIMTUNO_IP=$(ip -o -4 addr list uesimtun0 | awk '{print $4}' | cut -d/ -f1)
$ mtr --no-dns --report --report-cycles 60 -T -P 5201 -a ${UESIMTUNO_IP} iperf3
...
HOST: ueransim-ue-7f76db59c9-ltfl Loss%   Snt   Last   Avg  Best  Wrst StDev
  1.|-- 10.233.110.138             0.0%    60    1.0   1.0   0.7   2.2   0.2
  2.|-- 10.233.27.59               0.0%    60    1.1   1.1   0.6   2.2   0.3
```

* check latency (with free5gc upf) to google public dns

```bash
$ export UESIMTUNO_IP=$(ip -o -4 addr list uesimtun0 | awk '{print $4}' | cut -d/ -f1)
$ mtr --no-dns --report --report-cycles 60 -T -P 443 -a ${UESIMTUNO_IP} 8.8.8.8
...
HOST: ueransim-ue-7f76db59c9-ltfl Loss%   Snt   Last   Avg  Best  Wrst StDev
  1.|-- 10.233.110.138             0.0%    60    0.8   0.9   0.7   1.2   0.1
...
 17.|-- 8.8.8.8                   98.3%    60   17.3  17.3  17.3  17.3   0.0
```

* check latency (with eUPF) to iperf3 pod

```bash
$ export UESIMTUNO_IP=$(ip -o -4 addr list uesimtun0 | awk '{print $4}' | cut -d/ -f1)
$ mtr --no-dns --report --report-cycles 60 -T -P 5201 -a ${UESIMTUNO_IP} 10.233.110.159
...
HOST: ueransim-ue-7f76db59c9-ndqq Loss%   Snt   Last   Avg  Best  Wrst StDev
  1.|-- 10.100.100.254             0.0%    60    1.0   1.0   0.7   2.8   0.3
...
  3.|-- 10.233.110.159             0.0%    60    0.9   1.1   0.7   2.1   0.2
```

* check latency (with eUPF) to google public dns

```bash
$ export UESIMTUNO_IP=$(ip -o -4 addr list uesimtun0 | awk '{print $4}' | cut -d/ -f1)
$ mtr --no-dns --report --report-cycles 60 -T -P 443 -a ${UESIMTUNO_IP} 8.8.8.8
...
HOST: ueransim-ue-7f76db59c9-ndqq Loss%   Snt   Last   Avg  Best  Wrst StDev
  1.|-- 10.100.100.254             0.0%    60    1.3   1.1   0.8   1.6   0.2
...
 18.|-- 8.8.8.8                   96.7%    60   16.6  16.7  16.6  16.9   0.2
```

</p>
</details>

### Results

|scenario | raw | free5gc upf | eupf (container nat) | eupf (host nat) |
|---|---|---|---|---|
| tcp throughput (to neighbor pod) | 13.1 Gbit/sec | 286 Mbit/sec | 194 Mbit/sec | 231 Mbit/sec |
| latency (to neighbor pod) | 0.2 | 1.1 | 1.1 | 1.1 |
| latency (to google public DNS) | 16.4 | 17.3 | 16.7 | 16.7 |
